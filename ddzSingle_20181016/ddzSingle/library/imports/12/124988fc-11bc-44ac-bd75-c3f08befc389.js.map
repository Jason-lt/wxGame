{"version":3,"sources":["../../../../../../assets/Script/ddz/models/assets/Script/ddz/models/TableChatModel.js"],"names":["ddz","tableChatModel","tableMsgMap","mySeatId","msgPlayers","playingPlayers","parseTableChat","argument","seatId","parseInt","result","msgType","isFace","msgs","msg","cc","sys","os","OS_IOS","replace","push","playMsg","ty","NotificationCenter","trigger","EventType","SHOW_TABLE_CHAT","getMsgBySeatId","length","pop","getMsgCountBySeatId","getMsgPlayer","player","wx","createInnerAudioContext","autoplay","loop","volume","obeyMuteSwitch","fs","getFileSystemManager","onEnded","res","END_PLAY_TABLE_CHAT","unlinkSync","src","removePlayerFromPlayingList","destroy","START_PLAY_TABLE_CHAT","filePath","env","USER_DATA_PATH","recordFileType","revertFile","writeFileSync","hall","LOGW","play","access","path","success","fail","index","indexOf","splice","replay","i","clear"],"mappings":"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","file":"TableChatModel.js","sourceRoot":"../../../../../../assets/Script/ddz/models","sourcesContent":["/**\n * Created by xujing on 2018/4/13.\n */\n\nddz.tableChatModel = {\n\n    tableMsgMap:{\n        1:[],\n        2:[],\n        3:[]\n    },\n\n    mySeatId:0,\n\n    msgPlayers : {\n\n    },\n\n    playingPlayers:[],\n\n    parseTableChat:function (argument) {\n        var seatId = parseInt(argument.result.seatId);\n        var msgType = parseInt(argument.result.isFace);\n        if (seatId == this.mySeatId) {\n            //自己的消息不处理\n            // return;\n        }\n        if(msgType == 2){\n            var msgs = this.tableMsgMap[seatId];\n            var msg = argument.result.msg;\n            if (cc.sys.os == cc.sys.OS_IOS) {\n                msg = msg.replace(/\\r|\\n/g,'');\n            }\n\n            // ddz.LOGD(null, \"格式化后的b64:\" + msg);\n\n            msgs.push(msg); //把消息放入队列\n            this.playMsg(seatId);\n        }\n        else if(msgType == 0){\n            ty.NotificationCenter.trigger(ddz.EventType.SHOW_TABLE_CHAT, argument.result);\n        }\n    },\n\n    /**\n     * 通过坐位ID,获取消息\n     * @param seatId 坐位ID\n     * @returns {*}\n     */\n    getMsgBySeatId:function (seatId) {\n        var msgs = this.tableMsgMap[seatId];\n        var msg = null;\n        if (msgs.length > 0){\n            msg = msgs.pop();\n        }\n\n        return msg;\n    },\n\n    getMsgCountBySeatId:function (seatId) {\n        var msgs = this.tableMsgMap[seatId];\n        return msgs.length;\n    },\n\n    getMsgPlayer:function (seatId) {\n        // var player = this.msgPlayers[seatId];\n        // if (!player){\n           var player = wx.createInnerAudioContext();\n            player.autoplay = false;\n            player.loop = false;\n            player.volume = 1;\n        player.obeyMuteSwitch = true;\n\n            // this.msgPlayers[seatId] = player;\n\n            var fs = wx.getFileSystemManager();\n            player.onEnded(function (res) {\n                ty.NotificationCenter.trigger(ddz.EventType.END_PLAY_TABLE_CHAT, seatId);\n                fs.unlinkSync(player.src);\n                if (ddz.tableChatModel.getMsgCountBySeatId(seatId) > 0){\n                    ddz.tableChatModel.playMsg(seatId);\n                }\n                ddz.tableChatModel.removePlayerFromPlayingList(player); //从正在播放的列表中移除\n                player.destroy();\n            });\n        // }\n\n        return player;\n    },\n\n    playMsg:function (seatId) {\n        var msg = ddz.tableChatModel.getMsgBySeatId(seatId);\n        if (msg){\n\n            ty.NotificationCenter.trigger(ddz.EventType.START_PLAY_TABLE_CHAT, seatId);\n            var player = ddz.tableChatModel.getMsgPlayer(seatId);\n\n            var filePath = wx.env.USER_DATA_PATH + '/seat_' + seatId + '_msg.' + ddz.recordFileType;\n            var fs = wx.getFileSystemManager();\n            var revertFile = function () {\n                //把字符串转为本地音频文件\n                fs.writeFileSync(filePath ,msg , 'base64');\n\n                hall.LOGW(null, \"本地音频文件:\" + filePath);\n                player.src = filePath;\n                player.play();\n                ddz.tableChatModel.playingPlayers.push(player);\n            };\n\n            fs.access({\n                path : filePath,\n                success :function () {\n                    fs.unlinkSync(filePath);\n                    revertFile();\n                },\n                fail:function () {\n                    revertFile();\n                }\n            });\n        }\n    },\n\n    removePlayerFromPlayingList:function (player) {\n        var index = this.playingPlayers.indexOf(player);\n        this.playingPlayers.splice(index, 1);\n    },\n\n    replay:function () {\n        var player;\n        for (var i = 0; i < this.playingPlayers.length; i++){\n            player = this.playingPlayers[i];\n            player.play();\n        }\n    },\n\n    clear:function () {\n        var msgs;\n        for (var i in this.tableMsgMap){\n            msgs = this.tableMsgMap[i];\n            msgs.length = 0;\n        }\n\n        this.playingPlayers.length = 0;\n    }\n\n};"]}